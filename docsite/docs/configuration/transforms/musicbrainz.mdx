---
title: Musicbrainz Stage
toc_min_heading_level: 2
toc_max_heading_level: 5
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

The **Musicbrainz** [Stage](/configuration/transforms#stage) matches your Play data with the [MusicBrainz](https://musicbrainz.org/) database. If the match score is high enough then Multi-Scrobbler uses the match to correct and fill-in missing information in your Play data.

**This Stage is useful for standardizing your Scrobble's Play data, regardless of the Source it is coming from.**

Even if you have have strong opinions about the way your existing music is already tagged/organized you should consider adding the Musicbrainz Stage to your Sources, if only to benefit from adding [MBIDs to scrobbled metadata.](#using-partial-match)

<details>

<summary>Why Should I Prefer MusicBrainz?</summary>

<h3>More Than Mainstream Data</h3>

The [MusicBrainz database contains](https://musicbrainz.org/statistics)

* 37 million+ tracks
* 5 million+ albums
* 2.7 million+ artists

in over 200 languages, contributed by 10,000+ editors each year with many more users voting on edits. 

The database covers a much wider range of music than most commercial services since it isn't restricted by licensing or incentivized to prioritize mainstream music due to business interests. You are much more likely to find data for obscure, indie, and international artists.

<h3>As The Artist Intended</h3>

While some large services (Spotify) may be more consistent in data structure, the MusicBrainz equivalent data is likely to be more true to the way the Artist originally intended since individuals can devote effort to individual artists. A fan of an artist is much more likely to "get it right" for their favorite band than a corporate business trying to do the least amount of work for the largest result.

</details>

:::tip

If you are using [ENV Config](/configuration?config-type=env#configuration-types) for multi-scrobbler and just want a quick and easy setup, skip to [**ENV Configuration**](#env-configuration).

:::

## Configuration

### API Setup

To avoid rate limiting, MusicBrainz requires API users to identify themself using a [User-Agent that contains an email or URL.](https://wiki.musicbrainz.org/MusicBrainz_API/Rate_Limiting#How_can_I_be_a_good_citizen_and_be_smart_about_using_the_Web_Service?) You must set this in the `data` for your [stage configuration](http://localhost:3000/docs/configuration/transforms/#configuring-stages) in your [AIO Config](/configuration?configType=aio#configuration-types):

```json5 title="config.json"
{
  // ...
  "transformers": [
    {
      "type": "musicbrainz",
      "name": "MyMB",
      "data": {
        "apis": [
          {
            "contact": "contact@mydomain.com"
          }
        ]
      },
    }
  ]
}
```

### Stage Configuration

All of the properties found in [**Matching with Musicbrainz**](#matching-with-musicbrainz) section are configured in [Stage Configuration](/configuration/transforms#configuring-stages) as `defaults`.

Example:

```json5 title="config.json"
{
  // ...
  "transformers": [
    {
      "type": "musicbrainz",
      "name": "MyMB",
      "data": {
        "apis": [
          {
            "contact": "contact@mydomain.com"
          }
        ],
        "defaults": {
          "releaseStatusPriority": ["official"],
          "fallbackArtistSearch": "native",
          "releaseAllowEmpty": true
        }
      },
    }
  ]
}
```

### Rules

Each [Rule](/configuration/transforms#stage-rules) should be either a boolean, specifying if the transformed data should be used for this field, or a [`when` condition](/configuration/transforms#conditional-moditication):

```json5
{
    "type": "musicbrainz",
    "name": "MyMB"
    // ...
    "title": false, // will not apply any changes to Play title
    "artists": {
      "when": {/* ... */}, // will only apply changes to Play artists if "when" is satisfied
    /* ... */
    },
    "album": true // will always apply changes to Play album
    "meta": true // adds MusicBrainz MBIDs to scrobble data
}
```

## ENV Configuration

The general configuration shown above can also be configured from a selection of *presets* using [ENV Config](/configuration?configType=env#configuration-types) for individual Sources/Clients.

You must **always** include the `MB_CONTACT` ENV to [identify your application](#api-setup):

```ini
MB_CONTACT=contact@mydomain.com
```

To configure [stage defaults](http://localhost:3000/docs/configuration/transforms/musicbrainz/#stage-configuration) use `MB_PRESETS` with a comma-delimited list of presets you wish to apply. More than one preset can be applied, in which case they combine. You must choose at least one of the presets below:

* `default` - Applies no defaults. This is the same as using no options from [Matching With Musicbrainz](#matching-with-musicbrainz)
* `sensible` - Applies the [Sensible Default](#sensible-default) configuration for sorting releases
* `native` - Applies `fallbackArtistSearch: native` for [Artist Extraction](#artist-extraction) if the first search fails to find matches
* `aggressive` - Applies [Free Text Search](#free-text) `fallbackFreeTextSearch: true` if all other searches fail

Finally, use ENV `*_TRANSFORMS=musicbrainz` on each Source/Client you wish to apply this stage to. This applies the stage in the [`preTransform` Hook](#/configuration/transforms#lifecycle-hooks) with all [Rules](#rules) enabled.

The `*` stands for the prefix used for each Source/Client's ENV keys. Refer to the individual Source/Client Configuration sections to find this.

:::tip

Enhancing a scrobble with the `preTransform` hook for a Source means that all Clients that recieve the scrobble get the enhanced version. You only need to apply the transform once, for a Source, to use it everywhere for downstream Clients.

:::

<details>

<summary>Example Full Docker Deploy with ENV Configuration</summary>

Using [Jellyfin + Maloja](/quickstart#create-docker-compose-file) example from Quickstart:

```yaml
services:
  multi-scrobbler:
    image: foxxmd/multi-scrobbler
    container_name: multi-scrobbler
    environment:
      - MB_CONTACT=contact@mydomain.com
      - MB_PRESETS=sensible,native # creates sensible defaults with native fallback searching

      - JELLYFIN_URL=192.168.0.110:8096
      - JELLYFIN_APIKEY=c9fae8756fbf481ebd9c5bb56b
      - JELLYFIN_USER=MyUser
      - JELLYFIN_TRANSFORMS=musicbrainz # applies musicbrainz Stage to preTransform of Jellyfin source

      - MALOJA_URL=http://192.168.0.100:42010 # maloja receives enhanced scrobble from Jellyfin
      - MALOJA_API_KEY=myApiKey


    volumes:
      - "./config:/config"
    ports:
      - "9078:9078"
    restart: unless-stopped
```

</details>

## Matching with Musicbrainz

:::note

**All properties found in this section are optional.**

If you just want a sensible default for configuraion refer to the [Best Practices](#best-practices) section.

:::

Matching your Scrobble's Play data with a result from Musicbrainz is comprised of two steps:

* [**Searching**](#searching) Musicbrainz using parts of your Scrobble as queries
* [**Refining**](#refining) matched results to select the desired/allowed match

Both steps have separate configuration.

### Searching

The first step is making [search queries to the Musicbrainz database](https://musicbrainz.org/doc/MusicBrainz_API/Search) to try to get potential candidates. Multi-scrobbler uses the **title, artist(s), and album** from your Scrobble data to query for matches.

Musicbrainz agressively normalizes these fields in its database which means that if your Scrobble data contains major innaccuracies or phrases fields in a non-normal way, it's possible Musicbrainz won't find any matches. This is a more common occurrence when trying to match Scrobble data from Sources that don't support multiple artist data, like [Subsonic](/configuration/sources/subsonic) and [Last.fm](/configuration/sources/lastfm).

<details>

<summary>Examples of Bad Data</summary>

Last.fm Scrobble returns an Artist in the title and combines two artists into one string:

```json
{
    "title": "Endless Possibility (feat. Wheatus)",
    "artists": ["Bowling For Soup & Punk Rock Factory"]
}
```

The corresponding [Musicbrainz Recording](https://musicbrainz.org/release/85bf284b-8b39-414e-8ad9-61f593072588) has all artists separated and no artist in the title:

```json
{
    "title": "Endless Possibility",
    "artists": ["Bowling For Soup", "Punk Rock Factory", "Wheatus"]
}
```

</details>

**If a normal search using all the fields mentioned above does not return any matches Multi-scrobbler can try additional searches with modified queries:**

#### Album Only

If your Scrobble data contains a title, artist(s), and an album (all three fields) then Multi-scrobbler will **automatically** retry the search using only title and album.

#### Artist Extraction

If...

* [Album Only](#album-only) returns no results or did not run due to missing an album
* Your scrobble data contains only **one** artist string
* `fallbackArtistSearch` is set in [Stage Configuration](/configuration/transforms#configuring-stages)

Then Multi-scrobbler will attempt to extract multiple artists from your artist and track string. **This is not automatic. You must set `fallbackArtistSearch` to enable this additional search.**

`fallbackArtistSearch` can be set to **Native** or **Naive** mode:

<Tabs groupId="fallbackArtist" queryString>
    <TabItem value="native" label="Native (Recommended)">

    **Native** (`native`) mode uses an aggressive configuration of the [Native Stage](/configuration/transforms/native) to extract artists using common delimiters and common "joined" artist patterns from the artist and title string of your Scrobble data.


    :::tip

    If you already have a Native Stage configured you should use that instead, running it before the Musicbrainz stage.

    :::

    <details>

    <summary>Native Mode Example</summary>

    ```json
    {
        "title": "Endless Possibility (feat. Wheatus)",
        "artists": ["Bowling For Soup & Punk Rock Factory, My Cool Band"]
    }
    ```

    * Extracts `Bowling For Soup` `Punk Rock Factory` `My Cool Band` from artist string
    * Extracts `Wheatus` from title string
      * Removes `(feat. Wheatus)` from title string because it found an artist there

    Resulting data used for Musicbrainz search:

    ```json
    {
        "title": "Endless Possibility",
        "artists": ["Bowling For Soup", "Punk Rock Factory", "My Cool Band", "Wheatus"]
    }
    ```

    </details>

    [Stage Configuration](/configuration/transforms#configuring-stages) example:

    ```json5
    // ...
    "defaults": {
        "releaseStatusPriority": ["official"],
        // ...
        "fallbackArtistSearch": "native"
      }
    ```

    </TabItem>
    <TabItem value="naive" label="Naive">

    **Naive** (`naive`) mode looks for the first found common delimiter in the artist string. If it finds one then it uses the preceding value as the only artist in the Musicbrainz search. It does not try to extract additional artists from the artist string, or extract anything from the title string.

    <details>

    <summary>Naive Mode Example</summary>

    ```json
    {
        "title": "Endless Possibility (feat. Wheatus)",
        "artists": ["Bowling For Soup, Punk Rock Factory & Wheatus"]
    }
    ```

    * Finds `&` as first common delimiter, extracts "Bowling For Soup"

    Resulting data used for Musicbrainz search:

    ```json
    {
        "title": "Endless Possibility (feat. Wheatus)",
        "artists": ["Bowling For Soup"]
    }
    ```
    </details>

    [Stage Configuration](/configuration/transforms#configuring-stages) example:

    ```json5
    // ...
    "defaults": {
        "releaseStatusPriority": ["official"],
        // ...
        "fallbackArtistSearch": "naive"
      }
    ```

    </TabItem>
</Tabs>

#### Free Text

If both [Album Only](#album-only) and [Artist Extraction](#artist-extraction) searches fail to return results you can additionally enable **Free Text** search. This will search Musicbrainz for **all** text of your Scrobble data artist/title/album, without constraint. **This is not automatic. You must set `fallbackFreeTextSeach: true` to enable this additional search.**

:::warning

Free text search is **unconstrained** which means that Musicbrainz will match text in **any** part of a Recording (artist, release, or recording field), regardless of where it is found. This may lead to results that are unexpected and undesired.

If you know your Source's Play data is well organized you should not enable this. Free Text search should only be used if:

* your music is not well organized or
* there may be many alternative titles/artists for the music you listen to (such as with [psuedo-releases](https://wiki.musicbrainz.org/Release#Status))
* you can tolerate that matches may not be accurate for releases.
  * Generally, if you keep [score](#score) high then matched releases should *at least* be the right artist or what you would expect within a reason, as a match. The release may not be the one you actually listened to but it would be "close enough".

:::

[Stage Configuration](/configuration/transforms#configuring-stages) example:

```json5
// ...
"defaults": {
    "releaseStatusPriority": ["official"],
    // ...
    "fallbackArtistSearch": "native",
    "fallbackFreeTextSearch": true
  }
```

### Refining

### Score

Each match returned by MusicBrainz contains a numeric score representing how close it was to the search parameters. Set `score` in configuration to set a minimum score that must be met by matches. Default is `90`.

```json5
{
  // ...
  "score": 90 // matches must score 90 or higher to be considered
}
```

### Filtering

There are several attributes associated with the [Release](https://wiki.musicbrainz.org/Release) a [Recording](https://wiki.musicbrainz.org/Recording) (individual Track/song) belongs to that you may be interested in controlling. MS can use these attributes to filter what the final Recording selected to match against your Play data is.

An easy way to think about this:

* Do you prefer Albums, Singles, or EPs?
* Do you always want to use an official album release, or are bootleg or cancelled albums okay to use?
* Should a track that belongs to a Compilation album be allowed to match?
* What country do you prefer an album release to be from?

##### Release Attributes

These attributes (`attribute_name` in config) are:

* [Release **Status**](https://wiki.musicbrainz.org/Release#Status) (`releaseStatus`) - Is this release/album/ep official, promotional, bootleg, etc...
* [Release Group **Primary Type**](https://wiki.musicbrainz.org/Release_Group/Type#Primary_types) (`releaseGroupPrimaryType`) - Is this release an Album, Single, EP, etc...
* [Release Group **Secondary Type**](https://wiki.musicbrainz.org/Release_Group/Type#Secondary_types) (`releaseGroupSecondaryType`) - Is this release a compilation, soundtrack, remix, etc...
* [Release **Country**](https://beta.musicbrainz.org/doc/Release/Country) (`releaseCountry`) - What ISO2 country was this released in? US, GB, MX, etc...
  * MusicBrainz uses the special code `XW` to represent a "Worldwide" release AKA release not made specifically for a country

Each of the above attributes can be used to **filter** matches using `allow` (explicitly include) or `deny` (exclude) terms. The correct property name for each is like so:

```
[attribute_name]Allow = [...]
[attribute_name]Deny

EX to explicitly allow only release status "official"

"releaseStatusAllow": ["official"]

EX to exclude compilations

"releaseGroupSecondaryTypeDeny": ["compilation"]
```

#### Empty Releases

Sometimes a Recording may not have any associated Releases. This may be because there is not enough information about the Recording yet, or it was never included on an actual Release.

You may want to filter the majority of your matches by releases but allow matching a Recording that has no releases to begin with. To allow this set `releaseAllowEmpty` to `true` in configuration:

```json5
{
  // ...
  "releaseAllowEmpty": true // don't remove a match during filtering just because it has no releases
}
```

### Sorting

Each [Release Attribute](#release-attribute) has one additional property that can be used to **rank** releases based on the order of the values you give it. This is the `priority` property.

*After* matches have been [filtered](#filtering), the remaining matches will have their releases sorted. Release with an attribute that does not match are **not** removed, but they are sorted lower than releases that do match.

Sorting can be a good alternative to filtering: with filters there is a possibility your filters may eliminate all matches; if you want to ensure that **some** match will be used then sorting can ensure that the **best choice** out of those given will always be used, without accidentally ending up with **no choice**.

Sorting can be used instead of filters, or in conjunction with filters, it's your choice.

In configuration:

```
[attribute_name]Priority = [...]

EX to prefer "official" releases over everything else

"releaseStatusPriority": ["official"]

EX to prefer albums, then singles, over everything else

"releaseGroupPrimaryTypePriority": ["album", "single"]
```

If a rule is not present then multi-scrobbler defaults it to `true`.

## Best Practices

### Sensible Default

Generally, the Musicbrainz Stage can be used without any of the [optional configuration](#configuration) and you should still see good results from matches. The top [scored](#score) match is, anecdotally, good enough for correcting and filling in surface-level play data like Title and Artist names.

For a more opinionated match that will mirror what you would expect from data from large music services:

```json5
{
    // use official release over anything else
    "releaseStatusPriority": ["official"],
    // prefer album, then single, then ep
    "releaseGroupPrimaryTypePriority": ["album", "single", "ep"],
    // prefer worldwide release
    "releaseCountryPriority": ["XW"]
}
```

Consider adding [Artist Extraction](./?fallbackArtist=native#artist-extraction) in **Native Mode** if any of your Sources do not support multiple artists or your music collection is not tagged well.

```json5
{
 // add the line below to the sensible defaults above
 // (don't forget commas)
 "fallbackArtistSearch": "native"
}
```

### Filter Considerations

When using your own filters consider:

* Prefer `deny` over `allow`
  * Releases come in all kinds of formats. Since `allow` is explicit you may filter out your desired match without realizing it (correct data except for release type). Or the Musicbrainz data for a higher scored match may be appropriate but you did not include it, exhaustively.
* Prefer [Sorting](#sorting) over [Filtering](#filtering)
  * Sorting does not eliminate any matches. It is, generally, better to get **some** match than it is to have your Play data completely uncorrected because filtering eliminated all matches

### Using Partial Match

Use [Rules](#rules) to apply MusicBrainz match data selectively.

If you know that your music collection is well organized and you do not want to change the artists/title/album etc... sent to a [Client](/configuration/clients), you can still benefit from matches by only applying MBIDs using `meta` so that any Client that supports Musicbrainz data ([Koito](/configuration/clients/koito), [Tealfm](/configuration/clients/tealfm), [Listenbrainz](/configuration/clients/listenbrainz), [Rocksky](/configuration/clients/rocksky)) can still get that data.

<details>

<summary>Example</summary>

```json5 title="subsonic.json"
[
  { 
    "name": "MySubsonic",
    "data": { /* ... */},
    "options": {
      "playTransform": {
        "preCompare": [
          {
            "type": "musicbrainz",
            "name": "MyMB",
            "title": false,
            "artists": false,
            "album": false,
            "albumArtists": false,
            "meta": true
          }
        ]
      }
    }
  }
]
```

</details>

## Logging

If

* Musicbrainz is not returning matches
* Multi-scrobbler is using the wrong match
* or the resulting enhanced Scrobble is not what you expected

Enable logging by turning on [**Debug Mode**](/configuration#debug-mode) to help diagnose any issues with the Musicbrainz API and Scrobble enhancement. **Before creating an issue** please enable logging and include any logs with your issue as this is needed to debug.

If you have multiple Modification Stages and need to see the diff for your Play between each Stage, enable `"log":  "all"` in the individual [Modification Stage](http://localhost:3000/docs/configuration/transforms/musicbrainz/?fallbackArtist=native#artist-extraction).

<details>

<summary>Example</summary>

In a [Subsonic](/configuration/sources/subsonic) [File Config](/configuration?configType=file#configuration-types):

```json5 title="subsonic.json"
[
  { 
    "name": "MySubsonic",
    "data": { /* ... */},
    "options": {
      "playTransform": {
        // highlight-start
        "log": "all",
        // highlight-end
        "preCompare": [
          {
            "type": "musicbrainz",
            "name": "MyMB",
          }
        ]
      }
    }
  }
]
```

</details>

## Examples

### Minimal

<details>

<summary>Example</summary>

Your [AIO Config](/configuration?configType=aio#configuration-types):

```json5 title="config.json"
{
  // ...
  "transformers": [
    {
      "type": "musicbrainz",
      "name": "MyMB",
      "data": {
        "apis": [
          {
            "contact": "contact@mydomain.com"
          }
        ]
      },
    }
  ]
}
```

In a [Subsonic](/configuration/sources/subsonic) [File Config](/configuration?configType=file#configuration-types):

```json5 title="subsonic.json"
[
  { 
    "name": "MySubsonic",
    "data": { /* ... */},
    "options": {
      "playTransform": {
        "preCompare": [
          {
            "type": "musicbrainz",
            "name": "MyMB"
          }
        ]
      }
    }
  }
]
```
</details>

### Sensible Default

Using the config shown in [Sensible Default](#sensible-default).

<details>

<summary>Example</summary>

Your [AIO Config](/configuration?configType=aio#configuration-types):

```json5 title="config.json"
{
  // ...
  "transformers": [
    {
      "type": "musicbrainz",
      "name": "MyMB",
      "data": {
        "apis": [
          {
            "contact": "contact@mydomain.com"
          }
        ]
      },
      "defaults": {
        "releaseStatusPriority": ["official"],
        "releaseGroupPrimaryTypePriority": ["album", "single", "ep"],
        "releaseCountryPriority": ["XW"],
        "fallbackArtistSearch": "native"
      }
    }
  ]
}
```

In a [Subsonic](/configuration/sources/subsonic) [File Config](/configuration?configType=file#configuration-types):

```json5 title="subsonic.json"
[
  { 
    "name": "MySubsonic",
    "data": { /* ... */},
    "options": {
      "playTransform": {
        "preCompare": [
          {
            "type": "musicbrainz",
            "name": "MyMB"
          }
        ]
      }
    }
  }
]
```
</details>